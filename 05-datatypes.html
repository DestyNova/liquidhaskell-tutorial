<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Programming with Refinement Types</title>

    <link href="./css/bootstrap.css" rel="stylesheet">
    <link href="./css/bootstrap-theme.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/rust-book.css">
    <link rel="stylesheet" type="text/css" href="./css/editor.css">

  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>


<!-- <script type="text/javascript" src="js/jquery/jquery-1.7.1.min.js"></script> -->
<script type="text/javascript" src="./js/jquery/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="./js/angular/angular.js"></script>
<script type="text/javascript" src="./js/bootstrap/bootstrap.js"></script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

</head>
<body class="rustdoc" data-spy="scroll" data-target=".bs-docs-sidebar" ng-app="liquidDemo" ng-controller="LiquidDemoCtrl">

    <div id="nav">
       <button id="toggle-nav">
         <span class="sr-only">Toggle navigation</span>
         <span class="bar"></span>
         <span class="bar"></span>
         <span class="bar"></span>
       </button>
    </div>

<div id='toc' class='mobile-hidden'>
<ul class='chapter'>
<li><a href='01-intro.html'><b>1.</b>Introduction</a></li>
<ul class='section'>
<li><a href='01-intro.html#gowrong'><b>1.1.</b> Well-Typed Programs Do Go Wrong</a></li>
<li><a href='01-intro.html#refinement-types'><b>1.2.</b> Refinement Types</a></li>
<li><a href='01-intro.html#audience'><b>1.3.</b> Audience</a></li>
<li><a href='01-intro.html#getting-started'><b>1.4.</b> Getting Started</a></li>
<li><a href='01-intro.html#sample-code'><b>1.5.</b> Sample Code</a></li>
</ul>
<li><a href='02-logic.html'><b>2.</b>Logic &amp; SMT</a></li>
<ul class='section'>
<li><a href='02-logic.html#syntax'><b>2.1.</b> Syntax</a></li>
<li><a href='02-logic.html#semantics'><b>2.2.</b> Semantics</a></li>
<li><a href='02-logic.html#verification-conditions'><b>2.3.</b> Verification Conditions</a></li>
<li><a href='02-logic.html#examples-propositions'><b>2.4.</b> Examples: Propositions</a></li>
<li><a href='02-logic.html#examples-arithmetic'><b>2.5.</b> Examples: Arithmetic</a></li>
<li><a href='02-logic.html#examples-uninterpreted-function'><b>2.6.</b> Examples: Uninterpreted Function</a></li>
<li><a href='02-logic.html#recap'><b>2.7.</b> Recap</a></li>
</ul>
<li><a href='03-basic.html'><b>3.</b>Refinement Types</a></li>
<ul class='section'>
<li><a href='03-basic.html#definetype'><b>3.1.</b> Defining Types</a></li>
<li><a href='03-basic.html#errors'><b>3.2.</b> Errors</a></li>
<li><a href='03-basic.html#subtyping'><b>3.3.</b> Subtyping</a></li>
<li><a href='03-basic.html#writing-specifications'><b>3.4.</b> Writing Specifications</a></li>
<li><a href='03-basic.html#refining-function-types-pre-conditions'><b>3.5.</b> Refining Function Types: Pre-conditions</a></li>
<li><a href='03-basic.html#refining-function-types-post-conditions'><b>3.6.</b> Refining Function Types: Post-conditions</a></li>
<li><a href='03-basic.html#testing-values-booleans-and-propositions'><b>3.7.</b> Testing Values: Booleans and Propositions</a></li>
<li><a href='03-basic.html#putting-it-all-together'><b>3.8.</b> Putting It All Together</a></li>
<li><a href='03-basic.html#recap'><b>3.9.</b> Recap</a></li>
</ul>
<li><a href='04-poly.html'><b>4.</b>Polymorphism</a></li>
<ul class='section'>
<li><a href='04-poly.html#vectorbounds'><b>4.1.</b> Specification: Vector Bounds</a></li>
<li><a href='04-poly.html#verification-vector-lookup'><b>4.2.</b> Verification: Vector Lookup</a></li>
<li><a href='04-poly.html#inference-our-first-recursive-function'><b>4.3.</b> Inference: Our First Recursive Function</a></li>
<li><a href='04-poly.html#higher-order-functions-bottling-recursion-in-a-loop'><b>4.4.</b> Higher-Order Functions: Bottling Recursion in a <code>loop</code></a></li>
<li><a href='04-poly.html#sparsetype'><b>4.5.</b> Refinements and Polymorphism</a></li>
<li><a href='04-poly.html#recap'><b>4.6.</b> Recap</a></li>
</ul>
<li><a href='05-datatypes.html'><b>5.</b>Refined Datatypes</a></li>
<ul class='section'>
<li><a href='05-datatypes.html#autosmart'><b>5.1.</b> Sparse Vectors Revisited</a></li>
<li><a href='05-datatypes.html#orderedlists'><b>5.2.</b> Ordered Lists</a></li>
<li><a href='05-datatypes.html#binarysearchtree'><b>5.3.</b> Ordered Trees</a></li>
<li><a href='05-datatypes.html#recap'><b>5.4.</b> Recap</a></li>
</ul>
<li><a href='06-measure-bool.html'><b>6.</b>Boolean Measures</a></li>
<ul class='section'>
<li><a href='06-measure-bool.html#partial-functions'><b>6.1.</b> Partial Functions</a></li>
<li><a href='06-measure-bool.html#usingmeasures'><b>6.2.</b> Lifting Functions to Measures</a></li>
<li><a href='06-measure-bool.html#recap'><b>6.3.</b> Recap</a></li>
</ul>
<li><a href='07-measure-int.html'><b>7.</b>Numeric Measures</a></li>
<ul class='section'>
<li><a href='07-measure-int.html#plan'><b>7.1.</b> Plan</a></li>
<li><a href='07-measure-int.html#wholemeal-programming'><b>7.2.</b> Wholemeal Programming</a></li>
<li><a href='07-measure-int.html#specifying-list-dimensions'><b>7.3.</b> Specifying List Dimensions</a></li>
<li><a href='07-measure-int.html#lists-size-preserving-api'><b>7.4.</b> Lists: Size Preserving API</a></li>
<li><a href='07-measure-int.html#listreducing'><b>7.5.</b> Lists: Size Reducing API</a></li>
<li><a href='07-measure-int.html#dimension-safe-vector-api'><b>7.6.</b> Dimension Safe Vector API</a></li>
<li><a href='07-measure-int.html#dimension-safe-matrix-api'><b>7.7.</b> Dimension Safe Matrix API</a></li>
<li><a href='07-measure-int.html#recap'><b>7.8.</b> Recap</a></li>
</ul>
<li><a href='08-measure-sets.html'><b>8.</b>Elemental Measures</a></li>
<ul class='section'>
<li><a href='08-measure-sets.html#talking-about-sets'><b>8.1.</b> Talking about Sets</a></li>
<li><a href='08-measure-sets.html#quickcheck'><b>8.2.</b> Proving QuickCheck Style Properties</a></li>
<li><a href='08-measure-sets.html#listelems'><b>8.3.</b> Content-Aware List API</a></li>
<li><a href='08-measure-sets.html#permutations'><b>8.4.</b> Permutations</a></li>
<li><a href='08-measure-sets.html#uniqueness'><b>8.5.</b> Uniqueness</a></li>
<li><a href='08-measure-sets.html#unique-zippers'><b>8.6.</b> Unique Zippers</a></li>
<li><a href='08-measure-sets.html#recap'><b>8.7.</b> Recap</a></li>
</ul>
<li><a href='09-case-study-lazy-queues.html'><b>9.</b>Case Study: Okasaki's Lazy Queues</a></li>
<ul class='section'>
<li><a href='09-case-study-lazy-queues.html#queues'><b>9.1.</b> Queues</a></li>
<li><a href='09-case-study-lazy-queues.html#sized-lists'><b>9.2.</b> Sized Lists</a></li>
<li><a href='09-case-study-lazy-queues.html#queue-type'><b>9.3.</b> Queue Type</a></li>
<li><a href='09-case-study-lazy-queues.html#queue-operations'><b>9.4.</b> Queue Operations</a></li>
<li><a href='09-case-study-lazy-queues.html#recap'><b>9.5.</b> Recap</a></li>
</ul>
<li><a href='10-case-study-associative-maps.html'><b>10.</b>Case Study: Associative Maps</a></li>
<ul class='section'>
<li><a href='10-case-study-associative-maps.html#mapapi'><b>10.1.</b> Specifying Maps</a></li>
<li><a href='10-case-study-associative-maps.html#using-maps-well-scoped-expressions'><b>10.2.</b> Using Maps: Well Scoped Expressions</a></li>
<li><a href='10-case-study-associative-maps.html#lemmas'><b>10.3.</b> Implementing Maps: Binary Search Trees</a></li>
<li><a href='10-case-study-associative-maps.html#recap'><b>10.4.</b> Recap</a></li>
</ul>
<li><a href='11-case-study-pointers.html'><b>11.</b>Case Study: Pointers &amp; Bytes</a></li>
<ul class='section'>
<li><a href='11-case-study-pointers.html#heartbleeds-in-haskell'><b>11.1.</b> HeartBleeds in Haskell</a></li>
<li><a href='11-case-study-pointers.html#low-level-pointer-api'><b>11.2.</b> Low-level Pointer API</a></li>
<li><a href='11-case-study-pointers.html#a-refined-pointer-api'><b>11.3.</b> A Refined Pointer API</a></li>
<li><a href='11-case-study-pointers.html#assumptions-vs-guarantees'><b>11.4.</b> Assumptions vs Guarantees</a></li>
<li><a href='11-case-study-pointers.html#bytestring-api'><b>11.5.</b> ByteString API</a></li>
<li><a href='11-case-study-pointers.html#nested-bytestrings'><b>11.6.</b> Nested ByteStrings</a></li>
</ul>
<li><a href='12-case-study-AVL.html'><b>12.</b>Case Study: AVL Trees</a></li>
<ul class='section'>
<li><a href='12-case-study-AVL.html#avl-trees'><b>12.1.</b> AVL Trees</a></li>
<li><a href='12-case-study-AVL.html#specifying-avl-trees'><b>12.2.</b> Specifying AVL Trees</a></li>
<li><a href='12-case-study-AVL.html#smart-constructors'><b>12.3.</b> Smart Constructors</a></li>
<li><a href='12-case-study-AVL.html#inserting-elements'><b>12.4.</b> Inserting Elements</a></li>
<li><a href='12-case-study-AVL.html#rebalancing-trees'><b>12.5.</b> Rebalancing Trees</a></li>
<li><a href='12-case-study-AVL.html#refactoring-rebalance'><b>12.6.</b> Refactoring Rebalance</a></li>
<li><a href='12-case-study-AVL.html#deleting-elements'><b>12.7.</b> Deleting Elements</a></li>
<li><a href='12-case-study-AVL.html#functional-correctness'><b>12.8.</b> Functional Correctness</a></li>
</ul>
</ul>

</div>
  
<div id='page-wrapper'>
<div id='page'>
 
<section id="refineddatatypes" class="level1">
<h1>Refined Datatypes</h1>

<p>So far, we have seen how to refine the types of <em>functions</em>, to specify, for example, pre-conditions on the inputs, or postconditions on the outputs. Very often, we wish to define <em>datatypes</em> that satisfy certain invariants. In these cases, it is handy to be able to directly refine the the <code>data</code> definition, making it impossible to create illegal inhabitants.</p>
<section id="autosmart" class="level2">
<h2>Sparse Vectors Revisited</h2>
<p>As our first example of a refined datatype, let's revisit the sparse vector representation that we <a href="#sparsetype">saw earlier</a>. The <code>SparseN</code> type alias we used got the job done, but is not pleasant to work with because we have no way of determining the <em>dimension</em> of the sparse vector. Instead, let's create a new datatype to represent such vectors:</p>
<div id="program-pane-0" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-0" class="programbox">data Sparse a = SP { spDim   :: Int
                   , spElems :: [(Int, a)] } </div>
</div>

<p>Thus, a sparse vector is a pair of a dimension and a list of index-value tuples. Implicitly, all indices <em>other</em> than those in the list have the value <code>0</code> or the equivalent value type <code>a</code>.</p>
<p><br /><strong>Legal</strong> <code>Sparse</code> vectors satisfy two crucial properties. First, the dimension stored in <code>spDim</code> is non-negative. Second, every index in <code>spElems</code> must be valid, i.e. between <code>0</code> and the dimension. Unfortunately, Haskell's type system does not make it easy to ensure that <em>illegal vectors are not representable</em>.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<p><br /><strong>Data Invariants</strong> LiquidHaskell lets us enforce these invariants with a refined data definition:</p>
<div id="program-pane-1" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-1" class="programbox">{-@ data Sparse a = SP { spDim   :: Nat 
                       , spElems :: [(Btwn 0 spDim, a)]} @-}</div>
</div>

<p>Where, as before, we use the aliases:</p>
<div id="program-pane-2" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-2" class="programbox">{-@ type Nat        = {v:Int | 0 <= v}            @-}
{-@ type Btwn Lo Hi = {v:Int | Lo <= v && v < Hi} @-}</div>
</div>

<p><br /><strong>Refined Data Constructors</strong> The refined data definition is internally converted into refined types for the data constructor <code>SP</code>:</p>
<pre class="spec"><code>-- Generated Internal representation
data Sparse a where
  SP :: spDim:Nat
     -&gt; spElems:[(Btwn 0 spDim, a)]
     -&gt; Sparse a </code></pre>
<p>In other words, by using refined input types for <code>SP</code> we have automatically converted it into a <em>smart</em> constructor that ensures that <em>every</em> instance of a <code>Sparse</code> is legal. Consequently, LiquidHaskell verifies:</p>
<div id="program-pane-3" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-3" class="programbox">okSP :: Sparse String
okSP = SP 5 [ (0, "cat")
            , (3, "dog") ] </div>
</div>

<p>but rejects, due to the invalid index:</p>
<div id="program-pane-4" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-4" class="programbox">badSP :: Sparse String
badSP = SP 5 [ (0, "cat")
             , (6, "dog") ]</div>
</div>

<p><br /><strong>Field Measures</strong> It is convenient to write an alias for sparse vectors of a given size <code>N</code>. We can use the field name <code>spDim</code> as a <em>measure</em>, like <code>vlen</code>. That is, we can use <code>spDim</code> inside refinements<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<div id="program-pane-5" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-5" class="programbox">{-@ type SparseN a N = {v:Sparse a | spDim v == N} @-} </div>
</div>

<p><br /><strong>Sparse Products</strong> Let's write a function to compute a sparse product</p>
<div id="program-pane-6" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-6" class="programbox">{-@ dotProd :: x:Vector Int -> SparseN Int (vlen x) -> Int @-}
dotProd x (SP _ y) = go 0 y
  where 
    go sum ((i, v) : y') = go (sum + (x ! i) * v) y' 
    go sum []            = sum</div>
</div>

<p>LiquidHaskell verifies the above by using the specification to conclude that for each tuple <code>(i, v)</code> in the list <code>y</code>, the value of <code>i</code> is within the bounds of the vector <code>x</code>, thereby proving <code>x ! i</code> safe.</p>
<p><br /><strong>Folded Product</strong> We can port the <code>fold</code>-based product to our new representation:</p>
<div id="program-pane-7" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-7" class="programbox">{-@ dotProd' :: x:Vector Int -> SparseN Int (vlen x) -> Int @-}
dotProd' x (SP _ y) = foldl' body 0 y   
  where 
    body sum (i, v) = sum + (x ! i)  * v</div>
</div>

<p>As before, LiquidHaskell checks the above by <a href="#sparsetype">automatically instantiating refinements</a> for the type parameters of <code>foldl'</code>, saving us a fair bit of typing and enabling the use of the elegant polymorphic, higher-order combinators we know and love.</p>
<div id="Sanitization" class="hwex">
<br /><strong>Exercise: (Sanitization): </strong>Invariants are all well and good for data computed <em>inside</em> our programs. The only way to ensure the legality of data coming from <em>outside</em>, i.e. from the &quot;real world&quot;, is to write a sanitizer that will check the appropriate invariants before constructing a <code>Sparse</code> vector. Write the specification and implementation of a sanitizer <code>fromList</code>, so that the following typechecks:
<br /><br />
</div>
<div id="program-pane-8" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-8" class="programbox">fromList          :: Int   -> [(Int, a)] -> Maybe (Sparse a)
fromList dim elts = undefined   

{-@ test1 :: SparseN String 3 @-}
test1     = fromJust $ fromList 3 [(0, "cat"), (2, "mouse")]</div>
</div>

<div id="Addition" class="hwex">
<br /><strong>Exercise: (Addition): </strong>Write the specification and implementation of a function <code>plus</code> that performs the addition of two <code>Sparse</code> vectors of the <em>same</em> dimension, yielding an output of that dimension. When you are done, the following code should typecheck:
<br /><br />
</div>
<div id="program-pane-9" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-9" class="programbox">plus     :: (Num a) => Sparse a -> Sparse a -> Sparse a
plus x y = undefined 

{-@ test2 :: SparseN Int 3 @-}   
test2    = plus vec1 vec2 
  where 
    vec1 = SP 3 [(0, 12), (2, 9)]
    vec2 = SP 3 [(0, 8),  (1, 100)]</div>
</div>

</section>
<section id="orderedlists" class="level2">
<h2>Ordered Lists</h2>
<p>As a second example of refined data types, let's consider a different problem: representing <em>ordered</em> sequences. Here's a type for sequences that mimics the classical list:</p>
<div id="program-pane-10" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-10" class="programbox">data IncList a =
    Emp
  | (:<) { hd :: a, tl :: IncList a }   

infixr 9 :<</div>
</div>

<p>The Haskell type above does not state that the elements are in order of course, but we can specify that requirement by refining <em>every</em> element in <code>tl</code> to be <em>greater than</em> <code>hd</code>:</p>
<div id="program-pane-11" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-11" class="programbox">{-@ data IncList a =
        Emp
      | (:<) { hd :: a, tl :: IncList {v:a | hd <= v}}  @-}</div>
</div>

<p><br /><strong>Refined Data Constructors</strong> Once again, the refined data definition is internally converted into a &quot;smart&quot; refined data constructor</p>
<pre class="spec"><code>-- Generated Internal representation
data IncList a where
  Emp  :: IncList a
  (:&lt;) :: hd:a -&gt; tl:IncList {v:a | hd &lt;= v} -&gt; IncList a</code></pre>
<p>which ensures that we can only create legal ordered lists.</p>
<div id="program-pane-12" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-12" class="programbox">okList  = 1 :< 2 :< 3 :< Emp      -- accepted by LH

badList = 2 :< 1 :< 3 :< Emp      -- rejected by LH</div>
</div>

<p>Its all very well to <em>specify</em> ordered lists. Next, lets see how its equally easy to <em>establish</em> these invariants by implementing several textbook sorting routines.</p>
<p><br /><strong>Insertion Sort</strong> First, lets implement insertion sort, which converts an ordinary list <code>[a]</code> into an ordered list <code>IncList a</code>.</p>
<div id="program-pane-13" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-13" class="programbox">insertSort        :: (Ord a) => [a] -> IncList a 
insertSort []     = Emp 
insertSort (x:xs) = insert x (insertSort xs) </div>
</div>

<p>The hard work is done by <code>insert</code> which places an element into the correct position of a sorted list. LiquidHaskell infers that if you give <code>insert</code> an element and a sorted list, it returns a sorted list.</p>
<div id="program-pane-14" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-14" class="programbox">insert             :: (Ord a) => a -> IncList a -> IncList a
insert y Emp       = y :< Emp
insert y (x :< xs) 
  | y <= x         = y :< x :< xs 
  | otherwise      = x :< insert y xs</div>
</div>

<div id="Insertion Sort" class="hwex">
<br /><strong>Exercise: (Insertion Sort): </strong>Complete the implementation of the function below to use <code>foldr</code> to eliminate the explicit recursion in <code>insertSort</code>.
<br /><br />
</div>
<div id="program-pane-15" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-15" class="programbox">insertSort'     :: (Ord a) => [a] -> IncList a
insertSort' xs  = foldr f b xs
  where
     f          = undefined    -- Fill this in
     b          = undefined    -- Fill this in</div>
</div>

<p><br /><strong>Merge Sort</strong> Similarly, it is easy to write merge sort, by implementing the three steps. First, we write a function that <em>splits</em> the input into two equal sized halves:</p>
<div id="program-pane-16" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-16" class="programbox">split          :: [a] -> ([a], [a])
split (x:y:zs) = (x:xs, y:ys) 
  where 
    (xs, ys)   = split zs
split xs       = (xs, [])</div>
</div>

<p>Second, we need a function that <em>combines</em> two ordered lists</p>
<div id="program-pane-17" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-17" class="programbox">merge         :: (Ord a) => IncList a -> IncList a -> IncList a 
merge xs  Emp = xs
merge Emp ys  = ys
merge (x :< xs) (y :< ys) 
  | x <= y    = x :< merge xs (y :< ys)
  | otherwise = y :< merge (x :< xs) ys</div>
</div>

<p>Finally, we compose the above steps to divide (i.e. <code>split</code>) and conquer (<code>sort</code> and <code>merge</code>) the input list:</p>
<div id="program-pane-18" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-18" class="programbox">mergeSort :: (Ord a) => [a] -> IncList a
mergeSort []  = Emp  
mergeSort [x] = x :< Emp
mergeSort xs  = merge (mergeSort ys) (mergeSort zs) 
  where 
    (ys, zs)  = split xs</div>
</div>

<div id="QuickSort" class="hwex">
<br /><strong>Exercise: (QuickSort): </strong>Why is the following implementation of <code>quickSort</code> rejected by LiquidHaskell? Modify it so it is accepted.
<br /><br />
</div>
<p><strong>Hint: </strong>Think about how <code>append</code> should behave so that the <code>quickSort</code> has the desired property. Next, can you bottle that intuition into a suitable <em>specification</em> for <code>append</code> and then ensure that the code satisfies that specification.</p>
<p><strong>FIXME</strong> This is too big a jump for an exercise; explain it.</p>
<div id="program-pane-19" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-19" class="programbox">quickSort           :: (Ord a) => [a] -> IncList a
quickSort []        = Emp 
quickSort (x:xs)    = append x lessers greaters 
  where 
    lessers         = quickSort [y | y <- xs, y < x ]
    greaters        = quickSort [z | z <- xs, z >= x]

{-@ append :: x:a -> IncList {v:a | v < x}
                  -> IncList {v:a | x <= v}
                  -> IncList a
  @-}
append z Emp       ys = z :< ys
append z (x :< xs) ys = x :< append z xs ys </div>
</div>

</section>
<section id="binarysearchtree" class="level2">
<h2>Ordered Trees</h2>
<p>As a last example of refined data types, let us consider binary search ordered trees, defined thus:</p>
<div id="program-pane-20" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-20" class="programbox">data BST a = Leaf
           | Node { root  :: a
                  , left  :: BST a
                  , right :: BST a }</div>
</div>

<p><br /><strong>Binary Search Trees</strong> enjoy the <a href="http://en.wikipedia.org/wiki/Binary_search_tree">property</a> that each <code>root</code> lies (strictly) between the elements belonging in the <code>left</code> and <code>right</code> subtrees hanging off the root. The ordering invariant makes it easy to check whether a certain value occurs in the tree. If the tree is empty i.e. a <code>Leaf</code>, then the value does not occur in the tree. If the given value is at the root then the value does occur in the tree. If it is less than (respectively greater than) the root, we recursively check whether the value occurs in the left (respectively right) subtree.</p>
<div id="fig:bst" style="align: left; text-align:center;">
  <img src="img/bst.png" height="200px" style="display:block;  margin-left:auto; margin-right:auto">
  <div class="caption" style="text-align:center"><b>Figure 1.1:</b> A Binary Search Tree with values between 1 and 9.
           Each root's value lies between the values appearing
           in its left and right subtrees. </div>
</div>
<br>


<p>Figure <a href="#fig:bst">1.1</a> shows a binary search tree whose nodes are labeled with a subset of values from <code>1</code> to <code>9</code>. We might represent such a tree with the Haskell value:</p>
<div id="program-pane-21" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-21" class="programbox">okBST :: BST Int
okBST =  Node 6 
             (Node 2
                 (Node 1 Leaf Leaf)
                 (Node 4 Leaf Leaf))
             (Node 9
                 (Node 7 Leaf Leaf)
                 Leaf)</div>
</div>

<p><br /><strong>Refined Data Type</strong> The Haskell type says nothing about the ordering invariant, and hence, cannot prevent us from creating illegal <code>BST</code> values that violate the invariant. We can remedy this with a refined data definition that captures the invariant. The aliases <code>BSTL</code> and <code>BSTR</code> denote <code>BST</code>s with values less than and greater than some <code>X</code>, respectively.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></p>
<div id="program-pane-22" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-22" class="programbox">{-@ data BST a    = Leaf
                  | Node { root  :: a
                         , left  :: BSTL a root
                         , right :: BSTR a root } @-}
             
{-@ type BSTL a X = BST {v:a | v < X}             @-}
{-@ type BSTR a X = BST {v:a | X < v}             @-}</div>
</div>

<p><br /><strong>Refined Data Constructors</strong> As before, the above data definition creates a refined smart constructor for <code>BST</code></p>
<pre class="spec"><code>data BST a where
  Leaf :: BST a
  Node :: r:a -&gt; BST {v:a| v &lt; r}
       -&gt; BST {v:a | r &lt; v}
       -&gt; BST a</code></pre>
<p>which <em>prevents</em> us from creating illegal trees</p>
<div id="program-pane-23" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-23" class="programbox">badBST =  Node 6 
             (Node 4
                 (Node 1 Leaf Leaf)
                 (Node 2 Leaf Leaf))  -- Out of order, rejected 
             (Node 9
                 (Node 7 Leaf Leaf)
                 Leaf)</div>
</div>

<div id="Duplicates" class="hwex">
<br /><strong>Exercise: (Duplicates): </strong>Can a <code>BST Int</code> contain duplicates?
<br /><br />
</div>
<p><br /><strong>Membership</strong> Lets write some functions to create and manipulate these trees. First, a function to check whether a value is in a <code>BST</code>:</p>
<div id="program-pane-24" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-24" class="programbox">mem                 :: (Ord a) => a -> BST a -> Bool
mem _ Leaf          = False
mem k (Node k' l r)
  | k == k'         = True
  | k <  k'         = mem k l
  | otherwise       = mem k r </div>
</div>

<p><br /><strong>Singleton</strong> Next, another easy warm-up: a function to create a <code>BST</code> with a single given element:</p>
<div id="program-pane-25" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-25" class="programbox">one   :: a -> BST a
one x = Node x Leaf Leaf</div>
</div>

<p><br /><strong>Insertion</strong> Lets write a function that adds an element to a <code>BST</code>.<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<div id="program-pane-26" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-26" class="programbox">add                  :: (Ord a) => a -> BST a -> BST a
add k' Leaf          = one k'
add k' t@(Node k l r)
  | k' < k           = Node k (add k' l) r
  | k  < k'          = Node k l (add k' r)
  | otherwise        = t </div>
</div>

<p><br /><strong>Minimum</strong> For our next trick, lets write a function to delete the <em>minimum</em> element from a <code>BST</code>. This function will return a <em>pair</em> of outputs -- the smallest element and the remainder of the tree. We can say that the output element is indeed the smallest, by saying that the remainder's elements exceed the element. To this end, lets define a helper type: <a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<div id="program-pane-27" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-27" class="programbox">data MinPair a = MP { mElt :: a, rest :: BST a }</div>
</div>

<p>We can specify that <code>mElt</code> is indeed smaller than all the elements in <code>rest</code> via the data type refinement:</p>
<div id="program-pane-28" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-28" class="programbox">{-@ data MinPair a = MP { mElt :: a, rest :: BSTR a mElt} @-}</div>
</div>

<p>Finally, we can write the code to compute <code>MinPair</code></p>
<div id="program-pane-29" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-29" class="programbox">delMin                 :: (Ord a) => BST a -> MinPair a
delMin (Node k Leaf r) = MP k r
delMin (Node k l r)    = MP k' (Node k l' r)
  where
    MP k' l'           = delMin l 
delMin Leaf            = die "Don't say I didn't warn ya!"</div>
</div>

<div id="Delete" class="hwex">
<br /><strong>Exercise: (Delete): </strong>Use <code>delMin</code> to complete the implementation of <code>del</code> which <em>deletes</em> a given element from a <code>BST</code>, if it is present.
<br /><br />
</div>
<div id="program-pane-30" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-30" class="programbox">del                   :: (Ord a) => a -> BST a -> BST a
del k' t@(Node k l r) = undefined
del _  Leaf           = Leaf </div>
</div>

<p><strong>FIXME</strong> See issue about using RAW FIELDS vs PATTERN MATCHING.</p>
<div id="Safely Deleting Minimum" class="hwex">
<br /><strong>Exercise: (Safely Deleting Minimum): </strong>The function <code>delMin</code> is only sensible for non-empty trees. <a href="#usingmeasures">Read ahead</a> to learn how to specify and verify that it is only called with such trees, and then apply that technique here to verify the call to <code>die</code> in <code>delMin</code>.
<br /><br />
</div>
<p><strong>FIXME</strong> I shouldn't have to read a future chapter to complete an exercise in this chapter.</p>
<div id="BST Sort" class="hwex">
<br /><strong>Exercise: (BST Sort): </strong>Complete the implementation of <code>toIncList</code> to obtain a <code>BST</code> based sorting routine <code>bstSort</code>.
<br /><br />
</div>
<div id="program-pane-31" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>

  <!-- Verifying ... -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isChecking" ng-click="verifySource()">
    <span class="glyphicon glyphicon-hourglass"></span>
  </button>
 
  <!-- Safe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:green; z-index:1"
          ng-show="isSafe">
    <span class="glyphicon glyphicon-ok"></span>
  </button>


  <!-- Unsafe -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:red; z-index:1"
          ng-show="isUnsafe">
    <span class="glyphicon glyphicon-remove"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isError">
    <span class="glyphicon glyphicon-fire"></span>
  </button>

  <!-- Error -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="color:orange; z-index:1"
          ng-show="isCrash">
    <span class="glyphicon glyphicon-exclamation-sign"></span>
  </button>

  <div id="program-31" class="programbox">bstSort   :: (Ord a) => [a] -> IncList a
bstSort   = toIncList . toBST

toBST     :: (Ord a) => [a] -> BST a
toBST     = foldr add Leaf  

toIncList :: BST a -> IncList a
toIncList (Node x l r) = undefined
toIncList Leaf         = undefined</div>
</div>

<p><strong>Hint: </strong>This exercise will be a lot easier <em>if</em> you first finish the <code>quickSort</code> exercise. Note that the signature for <code>toIncList</code> does not use <code>Ord</code> and so you cannot use a sorting procedure to implement it.</p>
</section>
<section id="recap" class="level2">
<h2>Recap</h2>
<p>In this chapter we saw how LiquidHaskell lets you refine data type definitions to capture sophisticated invariants. These definitions are internally represented by refining the types of the data constructors, automatically making them &quot;smart&quot; in that they preclude the creation of illegal values that violate the invariants. We will see much more of this handy technique in future chapters.</p>
<p>One recurring theme in this chapter was that we had to create new versions of standard datatypes, just in order to specify certain invariants. For example, we had to write a special list type, with its own <em>copies</em> of nil and cons. Similarly, to implement <code>delMin</code> we had to create our own pair type.</p>
<p><br /><strong>This duplication</strong> of types is quite tedious. There should be a way to just slap the desired invariants on to <em>existing</em> types, thereby facilitating their reuse. In a few chapters, we will see how to achieve this reuse by <a href="http://goto.ucsd.edu/~rjhala/liquid/abstract_refinement_types.pdf">abstracting refinements</a> from the definitions of datatypes or functions in the same way we abstract the element type <code>a</code> from containers like <code>[a]</code> or <code>BST a</code>.</p>
</section>
</section>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The standard approach is to use abstract types and <a href="https://www.haskell.org/haskellwiki/Smart_constructors">smart constructors</a> but even then there is only the informal guarantee that the smart constructor establishes the right invariants.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Note that <em>inside</em> a refined <code>data</code> definition, a field name like <code>spDim</code> refers to the value of the field, but <em>outside</em> it refers to the field selector measure or function.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>We could also just <em>inline</em> the definitions of <code>BSTL</code> and <code>BSTR</code> into that of <code>BST</code> but they will be handy later.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>While writing this exercise I inadvertently swapped the <code>k</code> and <code>k'</code> which caused LiquidHaskell to protest.<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>This helper type approach is rather verbose. We should be able to just use plain old pairs and specify the above requirement as a <em>dependency</em> between the pairs' elements. Later, we will see how to do so using <a href="http://goto.ucsd.edu/~rjhala/liquid/abstract_refinement_types.pdf">abstract refinements</a>.<a href="#fnref5">↩</a></p></li>
</ol>
</section>

</div>
</div>

<!-- JavaScript below! ============================================== -->

  <script src="./js/ace/ace.js" type="text/javascript" charset="utf-8"></script> 
  <script src="./js/ace/theme-monokai.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/ace/mode-haskell.js"  type="text/javascript" charset="utf-8"></script>
  <script src="./js/liquid/tooltip.js"></script> 
  <script src="./js/liquid/annot.js"></script> 
  <script src="./js/liquid/config.js"></script> 
  <script src="./js/liquid/liquid.js"></script>

  <script type="text/javascript">
    var queryServerURL = "http://goto.ucsd.edu:8090/" ;
  </script>
  
  <!-- rust nav JS --> 
  <script type="text/javascript">
    window.playgroundUrl = "";
  </script>
  
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
  document.getElementById("toggle-nav").onclick = toggleNav;
  function toggleNav() {
    var toc = document.getElementById("toc");
    var pagewrapper = document.getElementById("page-wrapper");
    toggleClass(toc, "mobile-hidden");
    toggleClass(pagewrapper, "mobile-hidden");
  };

  function toggleClass(el, className) {
     // from http://youmightnotneedjquery.com/
     if (el.classList) {
       el.classList.toggle(className);
     } else {
       var classes = el.className.split(' ');
       var existingIndex = classes.indexOf(className);

       if (existingIndex >= 0) {
         classes.splice(existingIndex, 1);
       } else {
         classes.push(className);
       }

       el.className = classes.join(' ');
     }
  }

  // The below code is used to add prev and next navigation links to the bottom
  // of each of the sections.
  // It works by extracting the current page based on the url and iterates over
  // the menu links until it finds the menu item for the current page. We then
  // create a copy of the preceding and following menu links and add the
  // correct css class and insert them into the bottom of the page.
  // var toc = document.getElementById('toc').getElementsByTagName('a');
  // var href = document.location.pathname.split('/').pop();
  // if (href === 'index.html' || href === '') {
  //   href = 'README.html';
  // }

  // for (var i = 0; i < toc.length; i++) {
  //   if (toc[i].attributes['href'].value === href) {
  //     var nav = document.createElement('p');
  //     if (i > 0) {
  //       var prevNode = toc[i-1].cloneNode(true);
  //       prevNode.className = 'left';
  //       nav.appendChild(prevNode);
  //     }
  //     if (i < toc.length - 1) {
  //       var nextNode = toc[i+1].cloneNode(true);
  //       nextNode.className = 'right';
  //       nav.appendChild(nextNode);
  //     }
  //     document.getElementById('page').appendChild(nav);
  //     break;
  //   }
  // }

});
</script>
</body>
</html>
